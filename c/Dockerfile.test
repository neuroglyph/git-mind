# SPDX-License-Identifier: Apache-2.0
FROM alpine:latest

# Install build tools and git
RUN apk add --no-cache \
    build-base \
    git \
    bash \
    valgrind

# Create test user
RUN adduser -D testuser

# Configure git to use 'main' as default branch
RUN git config --global init.defaultBranch main

# Copy source
WORKDIR /build
COPY . .

# Build gitmind
RUN DOCKER_CONTAINER=1 DOCKER_BUILD=1 make clean && DOCKER_CONTAINER=1 DOCKER_BUILD=1 make

# Copy binary as root
RUN cp /build/gitmind /usr/local/bin/

# Set up test environment
USER testuser
WORKDIR /home/testuser

# Configure git for testuser
RUN git config --global init.defaultBranch main

ENTRYPOINT ["/bin/bash"]