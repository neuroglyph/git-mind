#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# git-mind post-merge hook - Verifies links after merges

# Only run if git-mind is initialized
if [ ! -d ".gitmind" ]; then
    exit 0
fi

echo "git-mind: Checking links after merge..."

# Run link integrity check
git-mind check --quiet 2>&1 | grep -E "(broken|invalid|missing)" && {
    echo "git-mind: Found broken links after merge"
    echo "git-mind: Run 'git-mind check --fix' to repair"
}

# Check for rename conflicts that might have been missed
# This happens when both branches renamed files differently
MERGE_HEAD=$(git rev-parse MERGE_HEAD 2>/dev/null || echo "")
if [ ! -z "$MERGE_HEAD" ]; then
    # Get renames from both parents
    RENAMES_OURS=$(git diff-tree -M --name-status -r HEAD^..HEAD | grep "^R" || true)
    RENAMES_THEIRS=$(git diff-tree -M --name-status -r MERGE_HEAD^..MERGE_HEAD | grep "^R" || true)
    
    # If we have renames from both sides, might need manual resolution
    if [ ! -z "$RENAMES_OURS" ] && [ ! -z "$RENAMES_THEIRS" ]; then
        echo "git-mind: Multiple renames detected in merge"
        echo "git-mind: Run 'git-mind repair' to resolve any conflicts"
    fi
fi

exit 0