# SPDX-License-Identifier: Apache-2.0
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run tests in Docker
      run: |
        echo "Running tests exactly as local development..."
        make test
    
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          target/debug/deps/*.exec
          target/debug/build/

  # Additional job for different OS (optional)
  test-cross-platform:
    name: Test Cross-Platform
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Run tests natively
      run: |
        cargo fmt --check
        cargo clippy -- -D warnings
        cargo test