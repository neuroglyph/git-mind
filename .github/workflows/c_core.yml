name: C-Core Gate
on: [pull_request]
permissions:
  contents: read
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install LLVM 20
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -O - https://apt.llvm.org/llvm.sh | sudo bash -s -- 20
          sudo apt-get install -y clang-20 clang-tidy-20 bear cppcheck libubsan0 make libsodium-dev
          sudo ln -sf /usr/bin/clang-tidy-20 /usr/local/bin/clang-tidy
          sudo ln -sf /usr/bin/clang++-20    /usr/local/bin/clang++
          sudo ln -sf /usr/bin/clang-20      /usr/local/bin/clang
      - name: Build & capture compile DB
        run: |
          cd core
          make clean || true
          bear -- make all
          mv compile_commands.json ../
      - name: clang-tidy (diff-guard)
        run: |
          clang-tidy -quiet -p . --config-file core/.clang-tidy \
            $(git ls-files 'core/**/*.c' 'core/**/*.h') \
            | tee clang-tidy-report-full.txt || true
          # Filter to just project warnings
          grep -E "^/.*core/|^core/" clang-tidy-report-full.txt > clang-tidy-report.txt || true
      - name: Enforce no new warnings
        run: bash tools/enforce_no_new_warnings.sh clang-tidy-report.txt tools/baseline.txt
      - run: cppcheck --enable=all --inconclusive --quiet src
      - run: python tools/run_fuzz.py 60