name: git-mind Review Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  handle-command:
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gitmind')
    runs-on: ubuntu-latest
    steps:
      # Checkout default branch (trusted code) â€” never the PR head.
      # issue_comment is a privileged context; checking out attacker-controlled
      # code would allow arbitrary execution with write permissions.
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check commenter permissions
        id: authz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENTER: ${{ github.event.comment.user.login }}
          REPO: ${{ github.repository }}
        run: |
          PERMISSION=$(gh api "repos/${REPO}/collaborators/${COMMENTER}/permission" --jq '.permission')
          if [[ "$PERMISSION" != "admin" && "$PERMISSION" != "write" && "$PERMISSION" != "maintain" ]]; then
            echo "User ${COMMENTER} does not have write access. Skipping."
            echo "authorized=false" >> "$GITHUB_OUTPUT"
          else
            echo "authorized=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        if: steps.authz.outputs.authorized == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        if: steps.authz.outputs.authorized == 'true'
        run: npm ci

      - name: Parse and execute command
        if: steps.authz.outputs.authorized == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Extract command from comment
          COMMAND=$(echo "$COMMENT_BODY" | grep -oP '/gitmind\s+\K(accept-all|accept\s+\d+|reject\s+\d+)' || true)

          if [ -z "$COMMAND" ]; then
            echo "No valid /gitmind command found"
            exit 0
          fi

          ACTION=$(echo "$COMMAND" | awk '{print $1}')
          INDEX=$(echo "$COMMAND" | awk '{print $2}')

          case "$ACTION" in
            accept-all)
              if node bin/git-mind.js review --batch accept --json; then
                REPLY="All pending suggestions accepted."
              else
                REPLY="Failed to accept suggestions."
              fi
              ;;
            accept)
              if [ -z "$INDEX" ] || ! [[ "$INDEX" =~ ^[0-9]+$ ]]; then
                REPLY="Invalid index. Usage: \`/gitmind accept <number>\`"
              elif node bin/git-mind.js review --batch accept --index "$INDEX" --json; then
                REPLY="Suggestion $INDEX accepted."
              else
                REPLY="Failed to accept suggestion $INDEX."
              fi
              ;;
            reject)
              if [ -z "$INDEX" ] || ! [[ "$INDEX" =~ ^[0-9]+$ ]]; then
                REPLY="Invalid index. Usage: \`/gitmind reject <number>\`"
              elif node bin/git-mind.js review --batch reject --index "$INDEX" --json; then
                REPLY="Suggestion $INDEX rejected."
              else
                REPLY="Failed to reject suggestion $INDEX."
              fi
              ;;
          esac

          if [ -n "$REPLY" ]; then
            gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
              -f body="**git-mind:** $REPLY"
          fi
